# 스레드 안전

스레드는 자신만 사용할 수 있는 스택 영역을 가지므로 스레드 여러 개가 있을 때 여러 스택 영역이 존재하게 됩니다. 이러한 스레드 정보를 `스레드 상황 정보(thread context)`라고 한다. 스레드는 스택 이외의 영역은 공유해서 사용합니다.

이때 서로 다른 스레드가 프로세스의 자원을 공유해서 사용하다 보면 `스레드 간 동기화 문제` 와 `교착상태(deadlock)` 등 문제가 발생할 수 있습니다. 

```
💡 스레드 간 동기화 문제란? 여러 스레드가 동시에 공유 자원에 접근하면 기대한 결과를 얻지 못하는 경우가 있습니다. 
이는 공유 자원에 대해 스레드의 접근을 제한하지 않으면 데이터의 일관성이 깨지기 때문입니다.
```

```
💡 교착 상태란? 두 개의 스레드가 서로 잡고 있는 자원을 기다리며 무한히 블록되는 상황을 말합니다. 
교착 상태를 방지하기 위해 상호 배제, 점유 대기, 비선점, 순환 대기와 같은 조건들을 해결해야 합니다.
```

가상 메모리를 살펴보면 어떤 영역에서 스레드 안전 문제가 발생할지 예측할 수 있습니다. 

- 코드 영역 
read-only 영역이기 때문에, 모든 스레드가 공유하지만 스레드 안전 문제가 발생하지 않습니다.
- 데이터 영역
전역 변수 등이 저장되는 영역이고, 모든 스레드가 접근 가능하기 때문에 변경도 공유됩니다.
- 힙 영역 
포인터를 얻을 수 있다면 포인터가 가리키는 데이터에 접근할 수 있기 때문에, 스레드 간 공유 리소스 입니다.
- 스택 영역
스택 영역은 스레드 전용 데이터이지만 힙 영역과 마찬 가지로 서로 다른 스레드의 스택 프레임에서의 포인터를 얻을 수 있다면 데이터에 접근할 수 있기 때문에, 스레드 간 공유 리소스입니다.

따라서, 여러 스레드가 특정 영역에 동시에 데이터에 접근할 수 있기 때문에 public한 스레드 간 공유 리소스에 대해 접근 할 때에는 주의해야 합니다. 

## 스레드 안전 코드는 도대체 어떻게 작성해야 할까?

```
💡 스레드 안전이란? 어떤 코드가 주어졌을 때, 그 코드가 개수와 호출 순서가 어떤 순서로 호출되든 간에 상관없이
올바른 결과가 나온다면, 이 코드는 스레드 안전이다.
```

1. 스레드 전용 리소스만 사용하기
2. call by value로 데이터 전달하기
3. readable한 전역 변수 사용하기
4. 스레드 전용 저장소 사용하기 
5. Lock 함수로 잠금 보호하기
6. 동기화 시 상호 배제 

**하지말아야 할 패턴**

1. 포인터로 파라미터 패싱
2. 함수에서 static 변수를 선언하고 참조를 반환하기 → 싱글톤으로 구현하여 해결할 수 있다.
